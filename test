package main

import (
	"fmt"
	client "github.com/influxdata/influxdb1-client/v2"
	"io"
	"io/ioutil"
	"net/http"
	"time"

	//"net/url"
	"os"
	"strconv"
)
const (
	MyDB = "YANGWUQI" //数据库名
	username = "yangwuqi" //用户名
	password = "19951129" //密码
)

var dataIndex int

func main() {
	url1:="http://localhost:9100/metrics"
	httpGet(dataIndex,url1)
}

func httpGet(dataIndex int,url1 string) {

	dataNumber := 0
	for {
		fmt.Println("每过5秒Get抓取数据！")

		resp, err := http.Get(url1)
		if err != nil {
			fmt.Println("http get error!")
			return
		}
		defer resp.Body.Close()

		body, err1 := ioutil.ReadAll(resp.Body)
		/*
		   ioutil.WriteFile("data"+strconv.Itoa(dataIndex),body,0644)
		*/

		if err1 != nil {
			fmt.Println("http read error!")
			return
		}

		dataFile, err := os.OpenFile("data"+strconv.Itoa(dataIndex), os.O_APPEND|os.O_CREATE, 0644)
		if err != nil {
			panic(err)
		}
		defer dataFile.Close()
		body = append(body[:], []byte("\n\n\n")...)
		n, err2 := dataFile.Write(body)
		if err2 == nil && n < len(body) {
			err2 = io.ErrShortWrite
		}

		fmt.Println(string(body))
		fmt.Println("Get获得数据并追加写入本地成功！")
		fmt.Println("Get抓取数据成功！数据批次是 ", dataNumber, "\n\n")
		dataNumber++

		if dataNumber==0{
			dbNAME:="MYDB"+strconv.Itoa(dataIndex)

			cli,err3:=client.NewHTTPClient(client.HTTPConfig{
				Addr: "http://10.15.165.3:8086",

			})
			if err3!=nil{
				panic(err3)
			}
			defer cli.Close()

			query:=client.NewQuery("CREATE DATABASE "+url1,"","")
			if response,err4:=cli.Query(query);err4==nil&&response.Error()==nil{
				fmt.Println("create database success! ",response.Results)
			}
		}
		//resp2, err4 := http.Post("http://localhost:8086/query","q=CREATE DATABASE "+dbNAME,readback)
		time.Sleep(5000000000)
	}
}
